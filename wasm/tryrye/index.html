<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rye evaluator - Rye Language</title>
  
  <link rel="icon" href="https://ryelang.org/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,700|Roboto:300,400,700&subset=latin-ext" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Londrina+Solid:wght@300&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="xterm.css" />
  
  <script src="wasm_exec.js"></script>
  <script src="jsGoo.js"></script>
  <script src="xterm.js"></script>
  <script src="ansi_to_html.js"></script>
  
  <style>
    body {
      font-family: Roboto;
      background-color: #222;
      padding: 0;
      margin: 0;
      font-size: 13px;
      height: 100vh;
      overflow: hidden;
    }
    
    .header {
      position: absolute;
      top: 10px;
      right: 20px;
      z-index: 100;
    }
    
    .home-link {
      color: #5DA5D5;
      text-decoration: none;
      font-size: 14px;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 4px;
      background-color: rgba(34, 34, 34, 0.8);
      transition: color 0.2s, background-color 0.2s;
    }
    
    .home-link:hover {
      color: #72F0FF;
      background-color: rgba(34, 34, 34, 1);
    }
    
    .container {
      display: flex;
      width: 100%;
      height: 100vh;
    }
    
    .left-panel {
      width: 50%;
      height: 100%;
      padding: 10px;
      box-sizing: border-box;
      background-color: #222;
      overflow: hidden;
    }
    
    .right-panel {
      width: 50%;
      height: 100%;
      padding: 10px;
      box-sizing: border-box;
      background-color: #333;
      color: #f1f1f1;
      display: flex;
      flex-direction: column;
    }
    
    .right-top {
      height: 50%;
      overflow: auto;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #555;
    }
    
    .right-bottom {
      height: 50%;
      overflow: auto;
    }
    
    .code-editor {
      width: 100%;
      height: calc(100% - 100px);
      background-color: #1e1e1e;
      color: #f1f1f1;
      font-family: 'Cascadia Code', Menlo, monospace;
      font-size: 13px;
      border: 1px solid #555;
      padding: 10px;
      box-sizing: border-box;
      resize: none;
    }
    
    .eval-button {
      margin-top: 10px;
      background-color: #5BCC5B;
      color: #111;
      padding: 5px 15px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    
    .eval-button:hover {
      background-color: #72FF72;
    }
    
    h1 {
      font-size: 110%;
    }
    
    textarea {
      width: 320px;
      box-model: content;
      padding: 10px;
      border: 0px solid red;
    }
    
    div#info pre {
      width: 80%;
      padding: 5px;
    }
    
    div#info pre.inl {
      display: inline;
    }
    
    pre {
      width: 320px;
      background-color: #c7fbf4;
      padding: 10px;
      box-model: content;
      font-size: 13px;
    }
    
    #header {
      padding: 10px 20px;
      background-color: #aeffff;
      margin-bottom: 10px;
      color: #595856;
      border-radius: 5px;
    }
    
    #info {
      float: left;
      width: 350px;
      padding: 10px;
    }
    
    #solution {
      float: left;
      width: 350px;
      padding: 10px;
      color: #556a62;
    }
    
    #code, .code_s {
      font-family: mono;
      font-size: 13px;
      border: 1px solid #c6c6c6;
      width: 360px;
      background-color: #f1f1f1;
    }
    
    #code_static1, #code_static2, .code_s {
      padding: 10px;
    }
    
    .cloud > div > img {
      width: 22px;
      vertical-align: bottom;
    }
    
    .cloud {
      margin: 0 0 10px 0;
      border-radius: 24px;
      padding: 15px;
      min-height: 45px;
      position: relative;
      color: #333;
    }
    
    .cloud > div {
      float: right;
      position: absolute;
      right: 15px;
      bottom: 12px;
    }
    
    .sample {
      background-color: #f1f1f1;
    }
    
    .task {
      background-color: #f1f1f1;
    }
    
    #intro {
      display: block;
      border: 1px solid #c1d5db;
      padding: 10px 20px 60px 20px;
      box-shadow: turquoise 1px 1px 10px;
    }
    
    #intro h3 {
      font-family: 'Londrina Solid', sans-serif;
      font-size: 22px;
      color: #3e1764;
      margin-bottom: 40px;
    }
    
    #intro p {
      margin-bottom: 25px;
    }
    
    #intro p.note {
      background-color: #dfffce;
      padding: 10px;
      color: #4f8c12;
      border-radius: 7px;
    }
    
    button {
      padding: 3px 6px 2px 6px;
      font-size: 13px;
      cursor: pointer;
      border: none;
      border-radius: 15px;
    }
    
    button.nav {
      border: none;
      background-color: transparent;
    }
    
    button.nav:disabled {
      opacity: 0.3;
    }
  </style>
</head>

<body>
  <div class="header">
    <a href="https://ryelang.org" class="home-link">Home</a>
  </div>
  <div class="container">
    <div class="left-panel">
      <h3 style="font-family: mono; font-weight: normal; font-size: 14px; color: #999; margin-top: 0;">Rye Chaff v0.0.1</h3>
      <div id="terminal" style="width: calc(100% - 30px); height: calc(100% - 50px); border: 1px solid gray; background-color: #111; padding: 10px; overflow: hidden;"></div>
    </div>
    <div class="right-panel">
      <div class="right-top">
        <h3 style="font-family: mono; font-weight: normal; font-size: 14px; color: #999; margin-top: 0;">Code Editor</h3>
        <textarea id="code-editor" class="code-editor" placeholder="Enter your Rye code here..."></textarea>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button id="eval-button" class="eval-button" onclick="evaluateCodeDirectly()">Evaluate Code</button>
          <button id="terminal-button" class="eval-button" style="background-color: #5D5DD3;" onclick="sendToTerminalCode()">Send to Console</button>
        </div>
      </div>
      <div class="right-bottom">
        <div style="display: flex; align-items: center; margin-bottom: 5px;">
          <h3 id="right-bottom-heading" style="font-family: mono; font-weight: normal; font-size: 14px; color: #999; margin: 0; flex-grow: 1;">Context Information</h3>
          <button onclick="updateContextWithLc()" style="margin-right: 10px; background-color: #5D5DD3; color: white; border-radius: 4px; padding: 3px 8px; font-size: 12px;">List Context</button>
          <label style="color: #999; display: flex; align-items: center; cursor: pointer; user-select: none;">
            <input type="checkbox" id="auto-context-checkbox" style="margin-right: 5px;" checked> Auto-update
          </label>
        </div>
        <div id="context-info" style="overflow: auto; height: calc(100% - 30px);">
          <div id="context-output" style="color: #f1f1f1; background-color: #222; white-space: pre-wrap; margin: 0; padding: 10px; font-family: 'Cascadia Code', Menlo, monospace; font-size: 13px; border-radius: 4px; width: 100%;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Terminal theme configuration
    var GLOB = { CollectedStdout: "", CollectStdout: false };
    var wasmInitialized = false;

    let theme = {
      foreground: '#F8F8F8',
      background: '#111314',
      selection: '#5DA5D533',
      black: '#1E1E1D',
      brightBlack: '#262625',
      red: '#CE5C5C',
      brightRed: '#FF7272',
      green: '#5BCC5B',
      brightGreen: '#72FF72',
      yellow: '#CCCC5B',
      brightYellow: '#FFFF72',
      blue: '#5D5DD3',
      brightBlue: '#7279FF',
      magenta: '#BC5ED1',
      brightMagenta: '#E572FF',
      cyan: '#5DA5D5',
      brightCyan: '#72F0FF',
      white: '#F8F8F8',
      brightWhite: '#FFFFFF'
    };
    
    // Initialize terminal
    var term = new Terminal({
      windowsMode: ['Windows', 'Win16', 'Win32', 'WinCE'].indexOf(navigator.platform) >= 0,
      fontFamily: '"Cascadia Code", Menlo, monospace',
      fontSize: 13,
      convertEol: true,
      rows: 40,
      cols: 80
    });
    
    term.options.theme = theme;
    term.options.cursorBlink = true;
    
    // Enable clipboard paste
    term.attachCustomKeyEventHandler((arg) => {
      if (arg.ctrlKey && arg.code === "KeyV" && arg.type === "keydown") {
        navigator.clipboard.readText()
          .then(text => {
            term.write(text);
          });
      }
      return true;
    });
    
    // Show loading message in terminal and context output
    term.writeln("\x1b[38;5;14m\r\nLoading WebAssembly module...\x1b[0m");
    document.getElementById('context-output').innerHTML = "<div style='color: #5DA5D5; padding: 10px; text-align: center; font-size: 14px;'><div style='margin-bottom: 10px;'>⏳ Loading WebAssembly module...</div><div>Please wait while the Rye environment is being initialized.</div></div>";
    
    // Initialize WebAssembly
    if (WebAssembly) {
      // WebAssembly.instantiateStreaming polyfill for Safari
      if (!WebAssembly.instantiateStreaming) {
        WebAssembly.instantiateStreaming = async (resp, importObject) => {
          const source = await (await resp).arrayBuffer();
          return await WebAssembly.instantiate(source, importObject);
        };
      }
      
      const go = new Go();
      // Show progress message
      term.writeln("\x1b[38;5;246m\r\nThis may take a few moments depending on your connection speed...\x1b[0m");
      
      WebAssembly.instantiateStreaming(fetch('main.wasm'), go.importObject).then(function(dat) {
        term.writeln("\x1b[38;5;10m\r\nWebAssembly module loaded successfully!\x1b[0m");
        term.writeln("Welcome to Rye web console. It's a work in progress. Visit \x1b[38;5;14mryelang.org\x1b[0m for more.");
        term.writeln("- \x1b[38;5;246mtype in lcp (list context parent) too see some functions, or lc to see yours \x1b[0m-");
        term.writeln("--------------------------------------------------------------------------------");
    
        go.run(dat.instance);
        InitRyeShell();
        window.SetTerminalSize(term.cols, term.rows);
        
        // Mark WebAssembly as initialized
        wasmInitialized = true;
        
        // Initialize context information after WebAssembly is fully loaded
        setTimeout(updateContextInfo, 1000);
        
        // Show initialization message
        document.getElementById('context-output').innerHTML = "<div style='color: #5BCC5B;'>WebAssembly environment initialized. Loading context...</div>";
      });
    } else {
      console.log("WebAssembly is not supported in your browser");
      term.writeln("\x1b[38;5;9m\r\nError: WebAssembly is not supported in your browser.\x1b[0m");
      document.getElementById('context-output').innerHTML = "<div style='color: #ff6b6b; padding: 10px; text-align: center;'><div style='font-size: 16px; margin-bottom: 10px;'>⚠️ WebAssembly Not Supported</div><div>This application requires WebAssembly support. Please try a different browser.</div></div>";
    }
    
    // Open terminal
    term.open(document.getElementById('terminal'));
    term.focus();
    
    // Calculate and set optimal terminal size based on container
    function resizeTerminal() {
      const terminalElement = document.getElementById('terminal');
      const availableHeight = terminalElement.clientHeight;
      const availableWidth = terminalElement.clientWidth;
      
      // Estimate character dimensions (approximate values)
      const charWidth = 7.2;  // Average width of a character in pixels
      const charHeight = 17;  // Average height of a line in pixels
      
      // Calculate optimal number of rows and columns
      const optimalCols = Math.floor(availableWidth / charWidth);
      const optimalRows = Math.floor(availableHeight / charHeight);
      
      // Update terminal dimensions
      term.resize(optimalCols, optimalRows);
      
      // Update Go WASM with new terminal size
      if (window.SetTerminalSize) {
        window.SetTerminalSize(optimalCols, optimalRows);
      }
    }
    
    // Initial resize and set up window resize listener
    setTimeout(resizeTerminal, 100);
    window.addEventListener('resize', resizeTerminal);

    // Note: Context initialization is now done after WebAssembly is loaded
    
    // Handle key events
    term.onKey((ev) => {
      window.SendKeypress(ev.domEvent.key, ev.domEvent.keyCode, ev.domEvent.ctrlKey, ev.domEvent.altKey, ev.domEvent.shiftKey);
    });
    
    // Functions for communication with Go WASM
    function evaluate(code, term) {
      var ret = RyeEvalString(code);
      term.write(ret);
    }
    
    function evaluateShellLine(code, term) {
      var ret = RyeEvalShellLine(code);
      return ret;
    }
    
    function receiveMessageFromGo(ret) {
      term.write(ret);
    }
    
    function receiveLineFromGo(line) {
      const result = evaluateShellLine(line, term);
      
      // If auto-context is enabled, update the context information
      if (document.getElementById('auto-context-checkbox').checked) {
        updateContextWithLc();
      }
      
      return result;
    }

    function receiveLineFromGo_noterm(line) {
      return alert(line);
    }
    
    function onWasmStdout(out) {
      if (GLOB.CollectStdout) {
        GLOB.CollectedStdout += out + "\n\r";
      } else {
        term.write(out + "\n\r");
      }
    }
    
    // Helper functions for sending commands to terminal
    function sendToTerminal(str, term) {
      for (var i = 0; i < str.length; i++) {
        if (str[i] == "\n") {
          window.SendKeypress('', 13, false, false, false);
        } else {
          window.SendKeypress(str[i], 0, false, false, false);
        }
        term.focus();
      }
    }
    
    // Function to send code to terminal
    function sendToTerminalCode() {
      const codeEditor = document.getElementById('code-editor');
      const code = codeEditor.value;
      if (code.trim() !== '') {
        sendToTerminal(code, term);
        // Update context info after code execution
        setTimeout(updateContextInfo, 500);
      }
    }
    
    // Function to evaluate code directly and display result in right-bottom area
    function evaluateCodeDirectly() {
      const codeEditor = document.getElementById('code-editor');
      const code = codeEditor.value;
      const contextOutput = document.getElementById('context-output');
      
      if (code.trim() !== '') {
        try {
          // Check if WebAssembly is initialized
          if (!wasmInitialized || typeof RyeEvalStringNoTerm !== 'function') {
            contextOutput.innerHTML = "<div style='color: #ff6b6b; padding: 10px;'>WebAssembly environment is still initializing. Please wait for the loading process to complete.</div>";
            return;
          }
          
          // Change heading to "Evaluation Result"
          document.getElementById('right-bottom-heading').textContent = "Evaluation Result";
          
          // Use RyeEvalStringNoTerm to evaluate without showing in terminal
          GLOB.CollectStdout = true;
          GLOB.CollectedStdout = "";

          const result = RyeEvalStringNoTerm(code);
          GLOB.CollectStdout = false;
          
          // Convert ANSI escape sequences to HTML
          const resultHtml = ansiToHtml(result);
          const stdoutHtml = ansiToHtml(GLOB.CollectedStdout);
          
          // Display the result in the context output area with HTML formatting
          contextOutput.innerHTML = "<div style='font-weight: bold;'>result</div><div style='border-bottom: 1px solid #444; margin-bottom: 10px;'></div>" + 
                                  resultHtml + 
                                  "<div style='font-weight: bold; margin-top: 20px;'>output</div><div style='border-bottom: 1px solid #444; margin-bottom: 10px;'></div>" + 
                                  stdoutHtml || "No result returned";
        } catch (error) {
          // Handle any errors
          contextOutput.innerHTML = "<div style='color: #ff6b6b;'>Error evaluating code: " + error.message + "</div>";
        }
      }
    }
    
    // Function to update context information
    function updateContextInfo() {
      // Initialize the checkbox state
      document.getElementById('auto-context-checkbox').checked = true;
      
      // Initialize the context with the current state
      updateContextWithLc();
    }
    
    // Function to update context with 'lc' command
    function updateContextWithLc() {
      try {
        // Check if WebAssembly is initialized
        if (!wasmInitialized || typeof RyeEvalStringNoTerm !== 'function') {
          document.getElementById('context-output').innerHTML = "<div style='color: #ff6b6b;'>WebAssembly environment is still initializing. Please try again in a moment.</div>";
          return;
        }
        
        // Change heading to "Context Information"
        document.getElementById('right-bottom-heading').textContent = "Context Information";
        
        // Use RyeEvalStringNoTerm to evaluate without showing in terminal
        GLOB.CollectStdout = true;
        GLOB.CollectedStdout = "";

        const result = RyeEvalStringNoTerm("lc");
        GLOB.CollectStdout = false;
        
        // Convert ANSI escape sequences to HTML
        const resultHtml = ansiToHtml(result);
        const stdoutHtml = ansiToHtml(GLOB.CollectedStdout);
        
        // Display the result in the context output area with HTML formatting
        const contextOutput = document.getElementById('context-output');
        contextOutput.innerHTML = "<div style='font-weight: bold;'>Context (lc)</div><div style='border-bottom: 1px solid #444; margin-bottom: 10px;'></div>" + 
                                resultHtml + 
                                (GLOB.CollectedStdout ? "<div style='font-weight: bold; margin-top: 20px;'>output</div><div style='border-bottom: 1px solid #444; margin-bottom: 10px;'></div>" + 
                                stdoutHtml : "");
      } catch (error) {
        // Handle any errors
        document.getElementById('context-output').innerHTML = "<div style='color: #ff6b6b;'>Error updating context: " + error.message + "</div>";
      }
    }
    
    function sendLinesToTerminal(multilineString, delay = 1000, term) {
      const lines = multilineString.split("\n");
      let index = 0;
      let isPaused = false;
      
      function printLine() {
        if (index > 0) {
          sendToTerminal("\n", term);
        }
        if (index < lines.length && !isPaused) {
          sendToTerminal(lines[index], term);
          index++;
          setTimeout(printLine, delay);
        }
      }
      
      return {
        start: () => printLine(),
        pause: () => (isPaused = true),
        resume: () => (isPaused = false),
      };
    }
    
    function onLoadX() {
      // Initialization function (kept for compatibility)
    }
  </script>
</body>
</html>
